name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      version_tag:
        required: true
        type: string
      domain:
        required: true
        type: string
    secrets:
      server_ip:
        required: true
      ssh_key:
        required: true
      env_file:
        required: true

env:
  ENV_SHORT: ${{ inputs.environment == 'production' && 'prod' || 'stg' }}
  DEPLOY_PATH: /opt/ecomama
  REGISTRY: ghcr.io

jobs:
  deploy:
    name: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/get-environment-url
        id: env-url
        with:
          environment: ${{ inputs.environment }}
          domain: ${{ inputs.domain }}

      - uses: ./.github/actions/setup-ssh
        with:
          ssh-key: ${{ secrets.ssh_key }}
          server-ip: ${{ secrets.server_ip }}

      - name: Transfer configuration
        run: |
          scp -r \
            docker-compose.production.yml \
            infrastructure/nginx/nginx.conf \
            infrastructure/nginx/app.conf.template \
            infrastructure/init-db.sql \
            deploy-server:${{ env.DEPLOY_PATH }}/${{ env.ENV_SHORT }}/
          
          echo "${{ secrets.env_file }}" | ssh deploy-server \
            "cat > ${{ env.DEPLOY_PATH }}/${{ env.ENV_SHORT }}/.env.${{ env.ENV_SHORT }}"

      - name: Execute deployment
        run: |
          ssh deploy-server "
            export REGISTRY='${{ env.REGISTRY }}/${{ github.repository_owner }}/'
            export VERSION='${{ inputs.version_tag }}'
            ${{ env.DEPLOY_PATH }}/scripts/deploy.sh ${{ env.ENV_SHORT }}
          "

      - uses: ./.github/actions/health-check
        with:
          url: ${{ steps.env-url.outputs.url }}
          timeout: '60'

      - uses: ./.github/actions/notify-deployment
        if: always()
        with:
          environment: ${{ inputs.environment }}
          status: ${{ job.status }}
          url: ${{ steps.env-url.outputs.url }}
          version: ${{ inputs.version_tag }}

      - uses: ./.github/actions/create-issue
        if: failure() && inputs.environment == 'production'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ðŸš¨ Production Deployment Failed - ${{ github.sha }}
          body: |
            **Environment:** ${{ inputs.environment }}
            **Version:** ${{ inputs.version_tag }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: deployment,critical
          assignees: ${{ github.actor }}
