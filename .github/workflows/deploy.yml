name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      version_tag:
        required: true
        type: string
      domain:
        required: true
        type: string
    secrets:
      server_ip:
        required: true
      ssh_key:
        required: true
      env_file:
        required: true

jobs:
  deploy:
    name: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment == 'production' && inputs.domain || format('staging.{0}', inputs.domain) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_key }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.server_ip }} >> ~/.ssh/known_hosts

      - name: Deploy config
        run: |
          scp -i ~/.ssh/key docker-compose.production.yml \
            infrastructure/nginx/nginx.conf \
            infrastructure/nginx/app.conf.template \
            infrastructure/init-db.sql \
            deploy@${{ secrets.server_ip }}:/opt/ecomama/${{ inputs.environment }}/
          
          echo "${{ secrets.env_file }}" | ssh -i ~/.ssh/key deploy@${{ secrets.server_ip }} \
            "cat > /opt/ecomama/${{ inputs.environment }}/.env.${{ inputs.environment }}"

      - name: Deploy
        run: |
          ssh -i ~/.ssh/key deploy@${{ secrets.server_ip }} "
            export REGISTRY='ghcr.io/${{ github.repository_owner }}/'
            export VERSION='${{ inputs.version_tag }}'
            /opt/ecomama/scripts/deploy.sh ${{ inputs.environment }}
          "

      - name: Verify
        run: |
          URL="https://${{ inputs.environment == 'production' && inputs.domain || format('staging.{0}', inputs.domain) }}/health"
          
          for i in {1..8}; do
            if curl -sf "$URL" &>/dev/null; then
              echo "‚úÖ Verified"
              exit 0
            fi
            sleep 5
          done
          
          echo "‚ùå Health check failed"
          exit 1

      - name: Create issue on failure
        if: failure() && inputs.environment == 'production'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Deployment Failed`,
              body: `**Commit:** ${context.sha}\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['deployment', 'critical'],
              assignees: [context.actor]
            });
