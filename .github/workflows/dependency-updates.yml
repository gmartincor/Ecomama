name: Dependency Updates

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

env:
  BASE_BRANCH: develop
  RETENTION_DAYS: 7

jobs:
  backend:
    name: Backend Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}

      - uses: ./.github/actions/setup-backend

      - uses: ./.github/actions/check-dependencies
        id: check
        with:
          service: backend
          working-directory: ./backend

      - if: steps.check.outputs.has-updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backend-dependency-report
          path: backend/build/dependencyUpdates/
          retention-days: ${{ env.RETENTION_DAYS }}

      - if: steps.check.outputs.has-updates == 'true'
        uses: ./.github/actions/create-issue
        with:
          title: 'chore(deps): backend dependency updates available'
          body: |
            Backend dependencies have updates available.
            
            Check the workflow artifacts for details.
            
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: dependencies,backend

  frontend:
    name: Frontend Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}

      - uses: ./.github/actions/setup-frontend

      - uses: ./.github/actions/check-dependencies
        id: check
        with:
          service: frontend
          working-directory: ./frontend

      - if: steps.check.outputs.has-updates == 'true'
        uses: ./.github/actions/update-dependencies
        with:
          service: frontend
          working-directory: ./frontend

      - if: steps.check.outputs.has-updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update frontend dependencies'
          branch: deps/frontend-updates
          title: 'chore(deps): update frontend dependencies'
          body: |
            Automated frontend dependency updates.
            
            Review changes and merge if all checks pass.
          labels: dependencies,frontend
